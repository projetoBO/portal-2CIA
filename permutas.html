import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  onSnapshot, 
  addDoc, 
  deleteDoc 
} from 'firebase/firestore';
import { 
  ChevronLeft, 
  ChevronRight, 
  CheckCircle, 
  PenSquare, 
  Home, 
  Settings, 
  Plus, 
  Trash2, 
  X,
  Lock
} from 'lucide-react';

// --- CONFIGURAÇÃO FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'permuta-oficial';

const ADMIN_PASSWORD = "32573515";

export default function App() {
  const [user, setUser] = useState(null);
  const [militares, setMilitares] = useState([]);
  const [isAdminMode, setIsAdminMode] = useState(false);
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [loginPassword, setLoginPassword] = useState("");
  
  // Estados do Formulário
  const [localizacao, setLocalizacao] = useState("TURIAÇU");
  const [pmSubstituido, setPmSubstituido] = useState({ nome: "", id: "" });
  const [pmSubstituto, setPmSubstituto] = useState({ nome: "", id: "" });
  const [comandante, setComandante] = useState("JOSE RIBAMAR BRAGA JUNIOR - 1º TEN QOPM");
  const [noPagamento, setNoPagamento] = useState(false);
  
  // Estados do Calendário
  const [serviceDates, setServiceDates] = useState({ start: null, end: null, currentMonth: new Date() });
  const [paymentDates, setPaymentDates] = useState({ start: null, end: null, currentMonth: new Date() });

  // Estado de Erros/Alertas
  const [alert, setAlert] = useState(null);

  // --- INICIALIZAÇÃO E AUTH ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Erro auth:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // --- BUSCA DE DADOS (FIRESTORE) ---
  useEffect(() => {
    if (!user) return;
    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'militares');
    const unsubscribe = onSnapshot(colRef, (snapshot) => {
      const list = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
      if (list.length === 0 && snapshot.metadata.fromCache === false) {
        const initialData = [
          { nome: "Cb PM 473/16 André", idMilitar: "849351" },
          { nome: "Sd PM 885/18 Albert", idMilitar: "871512" },
          { nome: "Sd PM 502/22 Sales", idMilitar: "869293" },
          { nome: "Sd PM 572/22 Theodósio", idMilitar: "871896" },
          { nome: "Sd PM 457/24 Eduardo Silva", idMilitar: "869987" }
        ];
        initialData.forEach(m => addDoc(colRef, m));
      }
      setMilitares(list.sort((a, b) => (a.nome || "").localeCompare(b.nome || "")));
    }, (error) => {
      console.error("Erro ao ler militares:", error);
    });
    return () => unsubscribe();
  }, [user]);

  // --- HELPERS DE FORMATAÇÃO (ORIGINAIS) ---
  const formatarDataRange = (startDate, endDate) => {
    if (!startDate) return '';
    const start = new Date(startDate);
    const end = endDate ? new Date(endDate) : start;
    
    const dates = [];
    let curr = new Date(start);
    while (curr <= end) {
      dates.push(new Date(curr));
      curr.setDate(curr.getDate() + 1);
    }

    if (dates.length === 1) {
      const d = dates[0];
      return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }

    let result = '';
    let currentMonth = dates[0].getMonth();
    let currentYear = dates[0].getFullYear();
    let daysInGroup = [];

    for (let i = 0; i < dates.length; i++) {
      const d = dates[i];
      if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
        daysInGroup.push(String(d.getDate()).padStart(2, '0'));
      } else {
        result += `${daysInGroup.join(', ')}/${String(currentMonth + 1).padStart(2, '0')}, `;
        currentMonth = d.getMonth();
        currentYear = d.getFullYear();
        daysInGroup = [String(d.getDate()).padStart(2, '0')];
      }
    }
    result += `${daysInGroup.join(' - ')}/${String(currentMonth + 1).padStart(2, '0')}/${currentYear}`;
    return result;
  };

  // --- LÓGICA DE IMPRESSÃO (EXATAMENTE O MODELO ORIGINAL) ---
  const handlePrint = () => {
    if (!pmSubstituido.nome || !pmSubstituto.nome || !serviceDates.start) {
      setAlert({ title: "Campos Incompletos", message: "Por favor, preencha todos os campos obrigatórios." });
      return;
    }

    const brasaoUrlPrint = 'https://i.ibb.co/prs9KzDJ/BRAS-O.png';
    const servicoPermutadoTexto = formatarDataRange(serviceDates.start, serviceDates.end);
    const pagamentoTexto = !noPagamento ? formatarDataRange(paymentDates.start, paymentDates.end) : '';
    
    const diffTime = serviceDates.end ? Math.abs(serviceDates.end - serviceDates.start) : 0;
    const diasServico = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    
    let tipo24Horas = diasServico === 1 ? 'X' : '&nbsp;';
    let tipo48Horas = diasServico === 2 ? 'X' : '&nbsp;';
    let tipo72Horas = diasServico >= 3 ? 'X' : '&nbsp;';

    const localizacaoSede = localizacao === 'SEDE' ? 'X' : '&nbsp;';
    const localizacaoTurilandia = localizacao === 'TURILÂNDIA' ? 'X' : '&nbsp;';
    const localizacaoTuriacu = localizacao === 'TURIAÇU' ? 'X' : '&nbsp;';

    const printContent = `
      <!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Formulário de Permuta - Impressão</title>
      <style>
          body { font-family: 'Times New Roman', Times, serif; margin: 1.5cm; line-height: 1.15; font-size: 12pt; }
          .container { width: 100%; max-width: 800px; margin: 0 auto; } .text-center { text-align: center; }
          .font-bold { font-weight: bold; } p { margin: 4px 0; } .header p { margin: 2px 0; }
          .text-sm { font-size: 11pt; } .text-xs { font-size: 9pt; } .text-base { font-size: 12pt; }
      </style></head><body>
      <div class="container">
          <div class="text-center" style="line-height: 1.15; margin: 0;">
              <img src="${brasaoUrlPrint}" alt="Brasão" style="width: 90px; height: 110px; display: block; margin: 0 auto 4px;">
              <p class="font-bold" style="margin: 0;">ESTADO DO MARANHÃO</p>
              <p class="text-sm" style="margin: 0;">SECRETARIA DE SEGURANÇA PÚBLICA</p>
              <p class="text-sm" style="margin: 0;">CPA/I-5 – 10º BPM</p>
              <p class="text-sm" style="margin: 0;">10º BATALHÃO DA POLÍCIA MILITAR DO MARANHÃO</p>
              <p class="text-sm" style="margin: 0;">2ª COMPANHIA DO 10° BATALHÃO DE POLÍCIA MILITAR</p>
              <p class="text-xs" style="margin: 0;">Rua Dr. Paulo Ramos, s/nº, Centro, Santa Helena - MA, Telefax: (98) 99243-6850 - Email: 2cia10bpm@gmail.com</p>
              <p class="font-bold" style="margin-top: 2rem; margin-bottom: 0;">FORMULÁRIO DE AUTORIZAÇÃO PARA PERMUTA DE SERVIÇO</p>
          </div>
          <div class="mt-4 mb-4" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
              <p class="text-base">SEDE: ( ${localizacaoSede} )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DPM TURILÂNDIA: ( ${localizacaoTurilandia} )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DPM TURIAÇU: ( ${localizacaoTuriacu} )</p>
          </div>
          <div style="margin-bottom: 0.25rem;">
              <p class="text-base">PM SUBSTITUÍDO: ${pmSubstituido.nome.toUpperCase()} - ${pmSubstituido.id}</p>
              <p style="margin-top: 4rem;">Assinatura:________________________________________</p>
          </div>
          <div style="margin-bottom: 0.25rem; margin-top: 1.5rem;">
              <p class="text-base">PM SUBSTITUTO: ${pmSubstituto.nome.toUpperCase()} - ${pmSubstituto.id}</p>
              <p style="margin-top: 4rem;">Assinatura:________________________________________</p>
          </div>
          <div class="mb-2" style="margin-top: 1.5rem;">
              <p class="text-base">Data do serviço permutado: ${servicoPermutadoTexto}</p>
              ${!noPagamento ? `<p class="text-base">Data do pagamento do serviço: ${pagamentoTexto}</p>` : ''}
          </div>
          <div class="mb-4" style="text-align: left; margin-left: 20px; margin-top: 1rem;">
              <p class="text-base">( ${tipo24Horas} ) 24 Horas - ( ${tipo48Horas} ) 48 Horas - ( ${tipo72Horas} ) 72 Horas</p>
          </div>
          <div class="text-center" style="margin-top: 2rem;">
              <p class="text-base" style="margin: 0;">AUTORIZO A PERMUTA ENTRE OS POLICIAIS MILITARES ACIMA RELACIONADOS: ( &nbsp; ) Sim &nbsp; ( &nbsp; ) Não</p>
              <p class="text-base" style="margin-top: 3rem; margin-bottom: 0;">_____________________________________________________</p>
              <p class="text-base" style="margin-top: 0.2rem; margin-bottom: 0;">${comandante.toUpperCase()}</p>
              <p class="text-sm" style="margin-top: 0;">COMANDANTE DA 2°CP/10°BPM</p>
          </div>
      </div></body></html>`;

    const printWindow = window.open('', '_blank');
    if (printWindow) {
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.onload = () => { printWindow.focus(); printWindow.print(); };
    }
  };

  // --- LÓGICA DE CALENDÁRIO ---
  const renderDays = (state, setState) => {
    const year = state.currentMonth.getFullYear();
    const month = state.currentMonth.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0,0,0,0);

    const days = [];
    for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} />);

    for (let i = 1; i <= lastDate; i++) {
      const d = new Date(year, month, i);
      const isPast = d < today;
      const isSelected = (state.start && d.getTime() === state.start.getTime()) || (state.end && d.getTime() === state.end.getTime());
      const isInRange = state.start && state.end && d > state.start && d < state.end;

      days.push(
        <div 
          key={`day-${i}`}
          onClick={() => {
            if (isPast) return;
            let newStart = state.start;
            let newEnd = state.end;
            if (!newStart || (newStart && newEnd)) {
              newStart = d;
              newEnd = null;
            } else {
              newEnd = d;
              if (newEnd < newStart) [newStart, newEnd] = [newEnd, newStart];
              const diff = Math.ceil(Math.abs(newEnd - newStart) / (1000 * 60 * 60 * 24));
              if (diff > 2) {
                setAlert({ title: "Intervalo Inválido", message: "Você pode selecionar no máximo 3 dias consecutivos." });
                newStart = d;
                newEnd = null;
              }
            }
            setState({ ...state, start: newStart, end: newEnd });
          }}
          className={`h-9 w-9 flex items-center justify-center rounded-full cursor-pointer transition-all text-sm
            ${isPast ? 'text-gray-300 cursor-not-allowed' : 'hover:bg-blue-100'}
            ${isSelected ? 'bg-blue-600 text-white font-bold' : ''}
            ${isInRange ? 'bg-blue-200 text-blue-800' : ''}
          `}
        >
          {i}
        </div>
      );
    }
    return days;
  };

  const AdminPanel = () => {
    const [newMilitar, setNewMilitar] = useState({ nome: "", idMilitar: "" });
    const addMilitar = async () => {
      if (!newMilitar.nome || !newMilitar.idMilitar || !user) return;
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'militares'), newMilitar);
      setNewMilitar({ nome: "", idMilitar: "" });
    };
    const deleteMilitar = async (idDoc) => {
      if (!user) return;
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'militares', idDoc));
    };

    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
          <div className="p-6 border-b flex justify-between items-center bg-gray-50">
            <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-blue-600" /> Gestão de Militares</h2>
            <button onClick={() => setIsAdminMode(false)} className="p-2 hover:bg-gray-200 rounded-full"><X size={20} /></button>
          </div>
          <div className="p-6 space-y-4 overflow-y-auto flex-1">
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 p-4 bg-blue-50 rounded-xl border border-blue-100">
              <input placeholder="Nome (Ex: Sd PM Silva)" className="p-2 border rounded-lg" value={newMilitar.nome} onChange={e => setNewMilitar({...newMilitar, nome: e.target.value})} />
              <input placeholder="ID (Matrícula)" className="p-2 border rounded-lg" value={newMilitar.idMilitar} onChange={e => setNewMilitar({...newMilitar, idMilitar: e.target.value})} />
              <button onClick={addMilitar} className="bg-blue-600 text-white rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-700"><Plus size={18} /> Adicionar</button>
            </div>
            <div className="space-y-2">
              {militares.map(m => (
                <div key={m.idDoc} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                  <div><p className="font-semibold text-gray-800">{m.nome}</p><p className="text-xs text-gray-500">ID: {m.idMilitar}</p></div>
                  <button onClick={() => deleteMilitar(m.idDoc)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><Trash2 size={18} /></button>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#483D8B] p-4 md:p-8 font-sans text-gray-900">
      {alert && (
        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
          <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <h3 className="text-xl font-bold mb-2">{alert.title}</h3>
            <p className="text-gray-600 mb-6">{alert.message}</p>
            <button onClick={() => setAlert(null)} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold">OK</button>
          </div>
        </div>
      )}

      {showAdminLogin && (
        <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
          <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><Lock size={20}/> Acesso Administrativo</h3>
            <input type="password" placeholder="Senha de Admin" className="w-full p-3 border rounded-xl mb-4" value={loginPassword} onChange={e => setLoginPassword(e.target.value)} />
            <div className="flex gap-2">
              <button onClick={() => setShowAdminLogin(false)} className="flex-1 py-2 border rounded-lg">Cancelar</button>
              <button onClick={() => { if(loginPassword === ADMIN_PASSWORD) { setIsAdminMode(true); setShowAdminLogin(false); setLoginPassword(""); } else { setAlert({ title: "Erro", message: "Senha incorreta." }); } }} className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">Entrar</button>
            </div>
          </div>
        </div>
      )}

      {isAdminMode && <AdminPanel />}

      <div className="max-w-5xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
        <header className="p-8 text-center border-b bg-gray-50 relative">
          <button onClick={() => setShowAdminLogin(true)} className="absolute top-4 right-4 p-2 text-gray-400 hover:text-blue-600"><Settings size={20} /></button>
          <img src="https://pm.ssp.ma.gov.br/wp-content/uploads/2023/05/BRASAO-SD-RAYOL-e1683655730963.png" className="h-20 mx-auto mb-4" alt="Brasão" />
          <h1 className="text-xl font-extrabold tracking-tight text-gray-800">ESTADO DO MARANHÃO</h1>
          <p className="text-sm text-gray-500 font-medium">SECRETARIA DE SEGURANÇA PÚBLICA</p>
          <p className="text-sm text-gray-500 mb-6">10º BATALHÃO DA POLÍCIA MILITAR - 2ª CIA</p>
          <div className="flex flex-col items-center gap-4">
             <h2 className="text-3xl font-black text-gray-900">Permuta de Serviço</h2>
             <select value={localizacao} onChange={e => setLocalizacao(e.target.value)} className="w-full max-w-xs p-3 border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-blue-500 outline-none transition-all">
                <option>TURIAÇU</option><option>SEDE</option><option>TURILÂNDIA</option>
             </select>
          </div>
        </header>

        <main className="p-6 md:p-10 space-y-10">
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100">
              <h3 className="font-bold text-blue-800 text-sm uppercase mb-4">1. PM Substituído</h3>
              <div className="space-y-4">
                <select className="w-full p-3 bg-white border rounded-xl" value={pmSubstituido.nome} onChange={e => { const m = militares.find(x => x.nome === e.target.value); setPmSubstituido({ nome: e.target.value, id: m ? m.idMilitar : "" }); }}>
                  <option value="">Selecione...</option>
                  {militares.map(m => <option key={m.idDoc} value={m.nome}>{m.nome}</option>)}
                </select>
                <input className="w-full p-3 bg-gray-100 border rounded-xl" placeholder="ID" readOnly value={pmSubstituido.id} />
              </div>
            </div>
            <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100">
              <h3 className="font-bold text-blue-800 text-sm uppercase mb-4">2. PM Substituto</h3>
              <div className="space-y-4">
                <select className="w-full p-3 bg-white border rounded-xl" value={pmSubstituto.nome} onChange={e => { const m = militares.find(x => x.nome === e.target.value); setPmSubstituto({ nome: e.target.value, id: m ? m.idMilitar : "" }); }}>
                  <option value="">Selecione...</option>
                  {militares.map(m => <option key={m.idDoc} value={m.nome}>{m.nome}</option>)}
                </select>
                <input className="w-full p-3 bg-gray-100 border rounded-xl" placeholder="ID" readOnly value={pmSubstituto.id} />
              </div>
            </div>
          </div>

          <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100">
            <h3 className="font-bold text-blue-800 text-sm uppercase mb-6">3. Datas da Permuta</h3>
            <div className="grid lg:grid-cols-2 gap-10">
              <div>
                <label className="font-bold text-gray-700 block mb-2">Data do Serviço Permutado</label>
                <div className="bg-white p-4 rounded-2xl border shadow-sm">
                  <div className="flex justify-between items-center mb-4">
                    <button onClick={() => setServiceDates({...serviceDates, currentMonth: new Date(serviceDates.currentMonth.setMonth(serviceDates.currentMonth.getMonth()-1))})}><ChevronLeft/></button>
                    <span className="font-bold">{serviceDates.currentMonth.toLocaleString('pt-BR', {month:'long', year:'numeric'})}</span>
                    <button onClick={() => setServiceDates({...serviceDates, currentMonth: new Date(serviceDates.currentMonth.setMonth(serviceDates.currentMonth.getMonth()+1))})}><ChevronRight/></button>
                  </div>
                  <div className="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-gray-400 mb-2">
                    {['D','S','T','Q','Q','S','S'].map((d, i) => <div key={`head-service-${i}`}>{d}</div>)}
                  </div>
                  <div className="grid grid-cols-7 gap-1">{renderDays(serviceDates, setServiceDates)}</div>
                </div>
              </div>
              <div>
                <div className="flex justify-between items-center mb-2"><label className="font-bold text-gray-700">Data do Pagamento</label><label className="flex items-center gap-2 text-xs font-semibold cursor-pointer"><input type="checkbox" checked={noPagamento} onChange={e => setNoPagamento(e.target.checked)} />Não há pagamento</label></div>
                {!noPagamento && (
                  <div className="bg-white p-4 rounded-2xl border shadow-sm">
                    <div className="flex justify-between items-center mb-4">
                      <button onClick={() => setPaymentDates({...paymentDates, currentMonth: new Date(paymentDates.currentMonth.setMonth(paymentDates.currentMonth.getMonth()-1))})}><ChevronLeft/></button>
                      <span className="font-bold">{paymentDates.currentMonth.toLocaleString('pt-BR', {month:'long', year:'numeric'})}</span>
                      <button onClick={() => setPaymentDates({...paymentDates, currentMonth: new Date(paymentDates.currentMonth.setMonth(paymentDates.currentMonth.getMonth()+1))})}><ChevronRight/></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center text-[10px] font-bold text-gray-400 mb-2">
                      {['D','S','T','Q','Q','S','S'].map((d, i) => <div key={`head-payment-${i}`}>{d}</div>)}
                    </div>
                    <div className="grid grid-cols-7 gap-1">{renderDays(paymentDates, setPaymentDates)}</div>
                  </div>
                )}
              </div>
            </div>
          </div>

          <div className="bg-gray-50 p-6 rounded-2xl border border-gray-100">
             <h3 className="font-bold text-blue-800 text-sm uppercase mb-4">4. Comandante</h3>
             <input className="w-full p-3 bg-white border rounded-xl" value={comandante} onChange={e => setComandante(e.target.value)} />
          </div>

          <div className="flex flex-wrap justify-center gap-4 pt-6 border-t">
            <button onClick={handlePrint} className="flex items-center gap-2 bg-blue-700 text-white px-8 py-4 rounded-2xl font-black shadow-lg transform hover:scale-105 transition-all"><CheckCircle size={22} /> CONCLUIR E IMPRIMIR</button>
            <button onClick={() => window.open('https://sso.acesso.gov.br/login', '_blank')} className="flex items-center gap-2 bg-gray-100 text-gray-700 px-8 py-4 rounded-2xl font-bold"><PenSquare size={20} /> ASSINAR NO GOV.BR</button>
            <a href="https://projetobo.github.io/portal-2CIA/home.html" className="flex items-center gap-2 bg-white border-2 border-gray-200 text-gray-500 px-8 py-4 rounded-2xl font-bold"><Home size={20} /> VOLTAR</a>
          </div>
        </main>
      </div>
    </div>
  );
}
